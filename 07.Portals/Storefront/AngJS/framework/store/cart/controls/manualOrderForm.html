<script type="text/ng-template" id="popupTemplate.html">
    <div class="mqf-popup-wrapper"
         ng-style="{ top: position().top+'px', left: position().left+'px' }"
         style="display: block;"
         ng-show="isOpen() && !moveInProgress"
         aria-hidden="{{ !isOpen() }}">
        <ul class="dropdown-menu" role="listbox">
            <li ng-repeat="match in matches track by $index"
                class="uib-typeahead-match"
                ng-class="{ active: isActive($index) }"
                ng-mouseenter="selectActive($index)"
                ng-click="selectMatch($index)"
                role="option"
                id="{{::match.id}}">
                <div uib-typeahead-match index="$index" match="match" query="query" template-url="templateUrl"></div>
            </li>
        </ul>
    </div>
</script>
<div ng-if="!manualOrderFormCtrl.cvAuthenticationService.isAuthenticated()"
     class="row">
    <h3 data-translate="ui.storefront.cart.controls.manualOrderForm.PleaseSignInToUseThisForm"></h3>
    <button type="button" class="btn btn-lg btn-primary"
            login-modal
            ng-click="loginModalCtrl.open(null, null, true)"
            ><span data-translate="ui.storefront.user.login.SignIn"></span></button>
</div>
<div ng-if="manualOrderFormCtrl.cvAuthenticationService.isAuthenticated()"
     class="row form-vertical"
     ng-form="manualOrderFormCtrl.forms.manualOrder">
    <div class="col-12">
        <h1 data-translate="ui.storefront.cart.controls.manualOrderForm.ConvertYourVendorQuoteToAnOrderManually"></h1>
    </div>
    <div class="col-sm-6">
        <div class="form-group">
            <h3 ng-class="{'text-success': manualOrderFormCtrl.vendorIsSelected}"
                ><span data-translate="ui.storefront.common.SelectAVendor"></span><!--
                --><span ng-if="manualOrderFormCtrl.vendorIsSelected"
                         >&nbsp;<i class="far fa-check"></i></span></h3>
            <div class="input-group">
                <input type="text" class="form-control"
                       translate-attr="{ placeholder: 'ui.storefront.cart.controls.manualOrderForm.EnterVendorName' }"
                       uib-typeahead="v as v.Name for v in manualOrderFormCtrl.grabVendors($viewValue)"
                       typeahead-popup-template-url="popupTemplate.html"
                       typeahead-loading="manualOrderFormCtrl.viewState.running" typeahead-wait-ms="500"
                       typeahead-min-length="1" typeahead-focus-first="false"
                       ng-keypress="manualOrderFormCtrl.inputKeyPress($event)"
                       ng-model="manualOrderFormCtrl.vendor" />
                <div class="input-group-append input-group-text"
                     aria-hidden="{{ !manualOrderFormCtrl.viewState.running }}"
                     ng-show="manualOrderFormCtrl.viewState.running">
                    <span class="input-group-text">
                        <i class="far fa-spinner fa-spin"></i>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div ng-if="manualOrderFormCtrl.vendorIsSelected"
         class="col-sm-6">
        <h3 ng-class="{'text-success': manualOrderFormCtrl.currentOrder.StoredFiles.length}"
            ><span data-translate="ui.storefront.cart.controls.manualOrderForm.UploadYourVendorQuoteFile"></span><!--
            --><span ng-if="manualOrderFormCtrl.currentOrder.StoredFiles.length"
                     >&nbsp;<i class="far fa-check"></i></span></h3>
        <div cef-upload-file-widget
             master="manualOrderFormCtrl.currentOrder"
             upload-type="StoredFileSalesOrder"
             type-key="General"
             allow-multiple="true"
             class="mb-3">
        </div>
    </div>
    <div ng-if="manualOrderFormCtrl.vendorIsSelected"
         class="col-12">
        <h3 ng-class="{ 'text-success': manualOrderFormCtrl.forms.manualOrder.$valid && manualOrderFormCtrl.items.length }"
            ><span data-translate="ui.storefront.common.AddProduct.Plural"></span><!--
            --><span ng-if="manualOrderFormCtrl.forms.manualOrder.$valid && manualOrderFormCtrl.items.length"
                     >&nbsp;<i class="far fa-check"></i></span></h3>
        <p>
            <span data-translate="ui.storefront.cart.controls.manualOrderForm.PleaseUseTheForm.Message"></span>&nbsp;<!--
            --><b ng-bind="manualOrderFormCtrl.vendor.Name"></b>
        </p>
    </div>
    <div ng-if="manualOrderFormCtrl.vendorIsSelected"
         class="col-sm-12 table-responsive">
        <table class="table table-striped table-hover table-sm">
            <colgroup>
                <col class="w-20" />
                <col class="w-15" />
                <col class="w-20" />
                <col class="w-10" />
                <col class="w-35" />
                <col style="width: 43px;" />
            </colgroup>
            <thead>
                <th data-translate="ui.storefront.cart.SKU"></th>
                <th data-translate="ui.storefront.catalog.YourPrice"></th>
                <th data-translate="ui.storefront.common.Quantity"></th>
                <th data-translate="ui.storefront.checkout.views.checkoutLabelItemTotal.avd"></th>
                <th data-translate="ui.storefront.common.Description"></th>
                <th></th>
            </thead>
            <tbody class="scroll-over-500">
                <tr ng-repeat="item in manualOrderFormCtrl.items"
                    ng-form="manualOrderFormCtrl.forms.manualOrder.item{{$index}}">
                    <td ng-class="{ 'has-error': manualOrderFormCtrl.forms.manualOrder['item'+$index]['txtItemProductKey'+$index].$invalid }">
                        <input type="text" class="form-control"
                               ng-if="!item.isDummy"
                               id="txtItemProductKey{{$index}}" name="txtItemProductKey{{$index}}"
                               translate-attr="{ placeholder: 'ui.storefront.cart.controls.manualOrderForm.EnterSKU' }"
                               ng-required="true"
                               uib-typeahead="p.CustomKey as ('[' + p.CustomKey + '] ' + p.Name)
                                              for p in manualOrderFormCtrl.grabVendorsProducts($viewValue, $index)"
                               typeahead-popup-template-url="popupTemplate.html"
                               typeahead-loading="manualOrderFormCtrl.viewState.running" typeahead-wait-ms="500"
                               typeahead-min-length="1" typeahead-focus-first="false"
                               typeahead-on-select="manualOrderFormCtrl.onItemSelect($item, $model, $label, $event, $index)"
                               ng-keypress="manualOrderFormCtrl.inputKeyPress($event)"
                               ng-model="item.ProductKey" />
                        <input type="text" class="form-control"
                               ng-if="item.isDummy"
                               id="txtItemProductKey{{$index}}U" name="txtItemProductKey{{$index}}U"
                               translate-attr="{ placeholder: 'ui.storefront.cart.controls.manualOrderForm.EnterSKU' }"
                               ng-required="true"
                               ng-keypress="manualOrderFormCtrl.inputKeyPress($event)"
                               ng-model="item.ForceUniqueLineItemKey" />
                    </td>
                    <td ng-class="{ 'has-error': manualOrderFormCtrl.forms.manualOrder['item'+$index]['nudItemUnitSoldPrice'+$index].$invalid }">
                        <input type="number" class="form-control text-right"
                               id="nudItemUnitSoldPrice{{$index}}" name="nudItemUnitSoldPrice{{$index}}"
                               placeholder="Enter Price"
                               min="0.0000" step="0.01"
                               ng-required="true"
                               ng-disabled="!item.ProductKey && !item.ForceUniqueLineItemKey"
                               ng-model="item.UnitSoldPrice" />
                    </td>
                    <td>
                        <div cef-add-to-cart-quantity-selector
                             item="item.Product"
                             sales-item="item"
                             default-value="1"
                             current-value="item.Quantity"
                             always-allow-input="true"
                             is-required="true"
                             external-disabled="!item.ProductKey"
                             step="1"
                             index="$index"></div>
                    </td>
                    <td>
                        <label class="d-block form-control-static font-weight-normal w-100 text-right"
                               ng-bind="((item.Quantity * item.UnitSoldPrice) | globalizedCurrency) || '-'"></label>
                    </td>
                    <td ng-class="{ 'has-error': manualOrderFormCtrl.forms.manualOrder['item'+$index]['txtItemName'+$index].$invalid }">
                        <input type="text" class="form-control"
                               id="txtItemName{{$index}}" name="txtItemName{{$index}}"
                               translate-attr="{ placeholder: 'ui.storefront.cart.controls.manualOrderForm.TypeTheDescriptionOfThisProduct' }"
                               ng-disabled="!item.ProductKey && !item.ForceUniqueLineItemKey"
                               ng-change="manualOrderFormCtrl.onNameChanged($event, $index)"
                               ng-required="true"
                               ng-model="item.Name" />
                    </td>
                    <td>
                        <button type="button" class="btn btn-link text-danger"
                                translate-attr="{ title: 'ui.storefront.common.Remove',
                                                  'aria-label': 'ui.storefront.common.Remove' }"
                                ng-disabled="manualOrderFormCtrl.items.length <= 1"
                                ng-click="manualOrderFormCtrl.remove($index)">
                            <i class="far fa-trash fa-lg"></i><!--
                            --><span class="sr-only"
                                     data-translate="ui.storefront.common.Remove"></span>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        <button type="button" class="btn btn-lg btn-primary"
                id="btnManualOrderFormAddItem" name="btnManualOrderFormAddItem"
                translate-attr="{ title: 'ui.storefront.cart.controls.manualOrderForm.AddAnotherProduct',
                                  'aria-label': 'ui.storefront.cart.controls.manualOrderForm.AddAnotherProduct' }"
                data-translate="ui.storefront.cart.controls.manualOrderForm.AddAnotherProduct"
                ng-click="manualOrderFormCtrl.addItem()"></button>
        <button type="button" class="btn btn-lg btn-secondary"
                id="btnManualOrderFormQuickCapture" name="btnManualOrderFormQuickCapture"
                translate-attr="{ title: 'ui.storefront.cart.controls.manualOrderForm.QuickCaptureMany',
                                  'aria-label': 'ui.storefront.cart.controls.manualOrderForm.QuickCaptureMany' }"
                data-translate="ui.storefront.cart.controls.manualOrderForm.QuickCaptureMany"
                ng-click="manualOrderFormCtrl.openQuickCaptureModal()"></button>
        <button type="button" class="btn btn-lg btn-secondary float-right"
                id="btnManualOrderFormContinue" name="btnManualOrderFormContinue"
                translate-attr="{ title: 'ui.storefront.checkout.views.orderConfirmation.Continue',
                                  'aria-label': 'ui.storefront.checkout.views.orderConfirmation.Continue' }"
                data-translate="ui.storefront.checkout.views.orderConfirmation.Continue"
                ng-disabled="!manualOrderFormCtrl.vendorIsSelected
                             || manualOrderFormCtrl.forms.manualOrder.$invalid
                             || !manualOrderFormCtrl.currentOrder.StoredFiles.length"
                ng-click="manualOrderFormCtrl.continue()"></button>
    </div>
</div>
