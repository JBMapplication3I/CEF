<div class="chatbox-popup modal-dialog">
    <header class="popup-header w-100">
        <div class="user">
            <!--<img src="images/avatar.png" alt="avatar" class="avatar" />-->
            <span class="name" ng-bind="chatWindowModalCtrl.cvAuthenticationService.currentUser.UserName"></span>
        </div>
        <!--<span class="saller-id">[SellerMemberID]</span>-->
        <div class="ml-auto">
            <button type="button" class="btn btn-link text-white"
                    translate-attr="{ title: 'ui.storefront.common.Close', 'aria-label': 'ui.storefront.common.Close' }"
                    ng-click="$close()"
                    data-translate="ui.storefront.common.Close"></button>
        </div>
    </header>
    <div class="popup-holder">
        <div class="popup-frame">
            <aside class="aside">
                <h4 data-translate="ui.storefront.messaging.chat.chatWindow.Conversations"></h4>
                <h4 class="text-center"><span ng-bind="chatWindowModalCtrl.cvChatService.activeConversations.length"></span>&nbsp;<!--
                --><span data-translate="ui.storefront.storeDashboard.storeNotifications.Active"></span></h4>
                <ul class="user-list mb-2">
                    <li ng-repeat="conversation in chatWindowModalCtrl.cvChatService.activeConversations"
                        ng-class="{'active': chatWindowModalCtrl.currentConversationID === conversation.ID}"
                        ng-click="chatWindowModalCtrl.switchToConversation(conversation.ID)">
                        <a class="py-2">
                            <!--<img src="images/avatar.png" alt="avatar" class="avatar" />-->
                            <span class="name">
                                <table>
                                    <tbody>
                                        <tr>
                                            <td><span data-translate="ui.storefront.common.Number.Symbol"></span><span ng-bind="conversation.ID"></span></td>
                                            <td><span ng-repeat="cu in conversation.ConversationUserUserNames track by $index"
                                                      ><span ng-bind="$first ? '' : ', '"></span><span ng-bind="cu"></span></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </span>
                        </a>
                    </li>
                </ul>
                <h4 class="text-center"><span ng-bind="chatWindowModalCtrl.cvChatService.endedConversations.length"></span>&nbsp;<!--
                --><span data-translate="ui.storefront.messaging.chat.chatWindow.Ended"></span></h4>
                <ul class="user-list">
                    <li ng-repeat="conversation in chatWindowModalCtrl.cvChatService.endedConversations"
                        ng-class="{'active': chatWindowModalCtrl.currentConversationID === conversation.ID}"
                        ng-click="chatWindowModalCtrl.switchToConversation(conversation.ID)">
                        <a class="py-2">
                            <!--<img src="images/avatar.png" alt="avatar" class="avatar" />-->
                            <span class="name">
                                <table>
                                    <tbody>
                                        <tr>
                                            <td><span data-translate="ui.storefront.common.Number.Symbol"></span><span ng-bind="conversation.ID"></span></td>
                                            <td><span ng-repeat="cu in conversation.ConversationUserUserNames track by $index"
                                                      ><span ng-bind="$first ? '' : ', '"></span><span ng-bind="cu"></span></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </span>
                        </a>
                    </li>
                </ul>
            </aside>
            <div class="chat-content" ng-hide="chatWindowModalCtrl.currentConversationID">
                <p class="w-100 p-3 text-center">
                    <span data-translate="ui.storefront.messaging.chat.chatWindow.PleaseSelectAConversationFromTheLeft"></span><!--
                    --><span ng-show="chatWindowModalCtrl.showForAnyContext()"
                             >&nbsp;<span data-translate="ui.storefront.messaging.chat.chatWindow.OrStartAConversationWithTheContextBelow"></span></span>
                </p>
                <div class="product-box m-2 pt-5 pl-2 pr-2 pb-2"
                     ng-cloak="chatWindowModalCtrl.product"
                     ng-hide="chatWindowModalCtrl.hideContextProduct">
                    <div class="top pb-6">
                        <img class="img-fluid img-thumbnail alignleft"
                             alt="{{chatWindowModalCtrl.product.Name}}"
                             ng-src="{{chatWindowModalCtrl.product.PrimaryImageFileName
                              | corsImageLink : 'products' : { 'maxwidth': 100, 'maxheight': 100, 'mode': 'pad', 'scale': 'both' } }}"
                             onerror="this.onerror=null;this.src='/DesktopModules/ClarityEcommerce/UI-Storefront/Content/placeholder.jpg?maxwidth=100&amp;maxheight=100&amp;mode=pad&amp;scale=both';" />
                        <div class="textbox">
                            <h5 ng-bind="chatWindowModalCtrl.product.Name"></h5>
                            <ul>
                                <li>
                                    <span class="heading" data-translate="ui.storefront.messaging.chat.chatWindow.FOBPrice"></span>
                                    <span class="txt"
                                        ng-bind="(chatWindowModalCtrl.product.readPrices().isSale
                                                  ? chatWindowModalCtrl.product.readPrices().sale
                                                  : chatWindowModalCtrl.product.readPrices().base) | globalizedCurrency">
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="bottom">
                        <b data-translate="ui.storefront.messaging.chat.chatWindow.AddThisProductAndBeginChat.QuestionMark"></b>
                        <button type="button" class="btn btn-warning"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                ng-click="chatWindowModalCtrl.selectProductAsContextProduct()"
                                data-translate="ui.storefront.common.Send"></button>
                        <button type="button" class="btn btn-link cancel"
                                translate-attr="{ title: 'ui.storefront.common.Cancel', 'aria-label': 'ui.storefront.common.Cancel' }"
                                ng-click="chatWindowModalCtrl.hideContextProduct = true"
                                data-translate="ui.storefront.common.Cancel"></button>
                    </div>
                </div>
                <div class="product-box m-2 pt-5 pl-2 pr-2 pb-2"
                     ng-cloak="chatWindowModalCtrl.salesOrder"
                     ng-hide="chatWindowModalCtrl.hideContextSalesOrder">
                    <div class="top pb-6">
                        <div class="textbox">
                            <h5><span data-translate="ui.storefront.common.SalesOrder"></span>&nbsp;<!--
                            --><span data-translate="ui.storefront.common.Number.Symbol"></span><!--
                            --><span ng-bind="chatWindowModalCtrl.salesOrder.ID"></span></h5>
                            <ul>
                            </ul>
                        </div>
                    </div>
                    <div class="bottom">
                        <b data-translate="ui.storefront.messaging.chat.chatWindow.AddThisSalesOrderAndBeginChat.QuestionMark"></b>
                        <button type="button" class="btn btn-warning"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                ng-click="chatWindowModalCtrl.selectSalesOrderAsContextSalesOrder()"
                                data-translate="ui.storefront.common.Send"></button>
                        <button type="button" class="btn btn-link cancel"
                                translate-attr="{ title: 'ui.storefront.common.Cancel', 'aria-label': 'ui.storefront.common.Cancel' }"
                                ng-click="chatWindowModalCtrl.hideContextSalesOrder = true"
                                data-translate="ui.storefront.common.Cancel"></button>
                    </div>
                </div>
                <div class="product-box m-2 pt-5 pl-2 pr-2 pb-2"
                     ng-cloak="chatWindowModalCtrl.salesReturn"
                     ng-hide="chatWindowModalCtrl.hideContextSalesReturn">
                    <div class="top pb-6">
                        <div class="textbox">
                            <h5><span data-translate="ui.storefront.common.SalesReturn"></span>&nbsp;<!--
                            --><span data-translate="ui.storefront.common.Number.Symbol"></span><!--
                            --><span ng-bind="chatWindowModalCtrl.salesReturn.ID"></span></h5>
                            <ul>
                            </ul>
                        </div>
                    </div>
                    <div class="bottom">
                        <b data-translate="ui.storefront.messaging.chat.chatWindow.AddThisSalesReturnAndBeginChat.QuestionMark"></b>
                        <button type="button" class="btn btn-warning"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                ng-click="chatWindowModalCtrl.selectSalesReturnAsContextSalesReturn()"
                                data-translate="ui.storefront.common.Send"></button>
                        <button type="button" class="tn btn-link ccancel"
                                translate-attr="{ title: 'ui.storefront.common.Cancel', 'aria-label': 'ui.storefront.common.Cancel' }"
                                ng-click="chatWindowModalCtrl.hideContextSalesReturn = true"
                                data-translate="ui.storefront.common.Cancel"></button>
                    </div>
                </div>
                <div class="product-box m-2 pt-5 pl-2 pr-2 pb-2"
                     ng-cloak="chatWindowModalCtrl.salesQuote"
                     ng-hide="chatWindowModalCtrl.hideContextSalesQuote">
                    <div class="top pb-6">
                        <div class="textbox">
                            <h5><span data-translate="ui.storefront.common.SalesQuote"></span>&nbsp;<!--
                            --><span data-translate="ui.storefront.common.Number.Symbol"></span><!--
                            --><span ng-bind="chatWindowModalCtrl.salesQuote.ID"></span></h5>
                            <ul>
                            </ul>
                        </div>
                    </div>
                    <div class="bottom">
                        <b data-translate="ui.storefront.messaging.chat.chatWindow.AddThisSalesQuoteAndBeginChat.QuestionMark"></b>
                        <button type="button" class="btn btn-warning"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                ng-click="chatWindowModalCtrl.selectSalesQuoteAsContextSalesQuote()"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                data-translate="ui.storefront.common.Send"></button>
                        <button type="button" class="btn btn-link cancel"
                                translate-attr="{ title: 'ui.storefront.common.Cancel', 'aria-label': 'ui.storefront.common.Cancel' }"
                                ng-click="chatWindowModalCtrl.hideContextSalesQuote = true"
                                data-translate="ui.storefront.common.Cancel"></button>
                    </div>
                </div>
                <div class="product-box m-2 pt-5 pl-2 pr-2 pb-2"
                     ng-cloak="chatWindowModalCtrl.salesInvoice"
                     ng-hide="chatWindowModalCtrl.hideContextSalesInvoice">
                    <div class="top pb-6">
                        <div class="textbox">
                            <h5><span data-translate="ui.storefront.common.SalesInvoice"></span>&nbsp;<!--
                            --><span data-translate="ui.storefront.common.Number.Symbol"></span><!--
                            --><span ng-bind="chatWindowModalCtrl.salesInvoice.ID"></span></h5>
                            <ul>
                            </ul>
                        </div>
                    </div>
                    <div class="bottom">
                        <b data-translate="ui.storefront.messaging.chat.chatWindow.AddThisSalesInvoiceAndBeginChat.QuestionMark"></b>
                        <button type="button" class="btn btn-warning"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                ng-click="chatWindowModalCtrl.selectSalesInvoiceAsContextSalesInvoice()"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                data-translate="ui.storefront.common.Send"></button>
                        <button type="button" class="btn btn-link cancel"
                                translate-attr="{ title: 'ui.storefront.common.Cancel', 'aria-label': 'ui.storefront.common.Cancel' }"
                                ng-click="chatWindowModalCtrl.hideContextSalesInvoice = true"
                                data-translate="ui.storefront.common.Cancel"></button>
                    </div>
                </div>
                <div class="product-box m-2 pt-5 pl-2 pr-2 pb-2"
                     ng-cloak="chatWindowModalCtrl.sampleRequest"
                     ng-hide="chatWindowModalCtrl.hideContextSampleRequest">
                    <div class="top pb-6">
                        <div class="textbox">
                            <h5><span data-translate="ui.storefront.common.SampleRequest"></span>&nbsp;<!--
                            --><span data-translate="ui.storefront.common.Number.Symbol"></span><!--
                            --><span ng-bind="chatWindowModalCtrl.sampleRequest.ID"></span></h5>
                            <ul>
                            </ul>
                        </div>
                    </div>
                    <div class="bottom">
                        <b data-translate="ui.storefront.messaging.chat.chatWindow.AddThisSampleRequestAndBeginChat.QuestionMark"></b>
                        <button type="button" class="btn btn-warning"
                                ng-click="chatWindowModalCtrl.selectSampleRequestAsContextSampleRequest()"
                                translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                data-translate="ui.storefront.common.Send"></button>
                        <button type="button" class="cancel"
                                translate-attr="{ title: 'ui.storefront.common.Cancel', 'aria-label': 'ui.storefront.common.Cancel' }"
                                ng-click="chatWindowModalCtrl.hideContextSampleRequest = true"
                                data-translate="ui.storefront.common.Cancel"></button>
                    </div>
                </div>
            </div>
            <div class="chat-content" ng-show="chatWindowModalCtrl.currentConversationID">
                <!-- chat-block -->
                <div class="chat-block py-3 pr-3 pl-5" du-scroll-container>
                    <div ng-repeat="message in chatWindowModalCtrl.filteredData"
                         ng-class="message.SentByUserID === chatWindowModalCtrl.cvAuthenticationService.currentUser.ID ? 'chat-frame' : 'chat-holder'">
                        <span class="small"
                              ng-hide="message.SentByUserID === chatWindowModalCtrl.filteredData[$index-1].SentByUserID
                                       && (message.CreatedDate | date: 'yyyy/MM/dd') === (chatWindowModalCtrl.filteredData[$index-1].CreatedDate | date: 'yyyy/MM/dd')"
                              ng-bind="message.SentByUserUserName + ' - ' + (message.CreatedDate | date: 'yyyy/MM/dd hh:mm:ss a')"></span>
                        <div class="chat-box p-3"
                             ng-class="{'mb-3': message.SentByUserID !== chatWindowModalCtrl.filteredData[$index+1].SentByUserID}"
                             ng-bind="message.Body"></div>
                    </div>
                    <div id="chatBlockBottom"></div>
                </div>
                <!--Other user typing statuses (aggregate as "X is typing, Y is typing...")-->
                <div class="is-typing-block p-1"
                     ng-show="!chatWindowModalCtrl.cvChatService.getConversation(chatWindowModalCtrl.currentConversationID).HasEnded">
                    <span ng-repeat="userTypingStatus in chatWindowModalCtrl.cvChatService.otherConversationUsersTypingStatuses
                                                            | filter: {'Status':'true','UserID':'!'+chatWindowModalCtrl.cvAuthenticationService.currentUser.ID}">
                        <span ng-if="!$first">, </span><span ng-bind="userTypingStatus.UserName"></span>&nbsp;<!--
                        --><span data-translate="ui.storefront.messaging.chat.chatWindow.IsTyping.Ellipses"></span>
                    </span>
                </div>
                <div class="chat-message p-3">
                    <table>
                        <tbody>
                            <tr>
                                <td class="w-99" rowspan="2">
                                    <textarea class="form-control p-2" rows="3"
                                              placeholder="{{chatWindowModalCtrl.cvChatService.getConversation(chatWindowModalCtrl.currentConversationID).HasEnded ? 'This conversation has ended' : 'Type your message here...'}}"
                                              ng-keypress="chatWindowModalCtrl.onKeyPress($event)"
                                              ng-keyup="chatWindowModalCtrl.sendMessageByKeyStroke($event)"
                                              ng-disabled="chatWindowModalCtrl.cvChatService.getConversation(chatWindowModalCtrl.currentConversationID).HasEnded"
                                              ng-model="chatWindowModalCtrl.newMessage[chatWindowModalCtrl.currentConversationID]"></textarea>
                                </td>
                                <td class="w-1 align-top">
                                    <button type="button" class="btn btn-block btn-warning"
                                            translate-attr="{ 'title': 'ui.storefront.messaging.chat.chatWindow.EndChat', 'aria-label': 'ui.storefront.messaging.chat.chatWindow.EndChat' }"
                                            ng-disabled="chatWindowModalCtrl.cvChatService.getConversation(chatWindowModalCtrl.currentConversationID).HasEnded"
                                            ng-click="chatWindowModalCtrl.endConversation()"
                                            data-translate="ui.storefront.messaging.chat.chatWindow.EndChat"></button>
                                </td>
                            </tr>
                            <tr>
                                <td class="align-bottom">
                                    <button type="button" class="btn btn-block btn-lg btn-primary"
                                            ng-disabled="chatWindowModalCtrl.cvChatService.getConversation(chatWindowModalCtrl.currentConversationID).HasEnded || !chatWindowModalCtrl.newMessage[chatWindowModalCtrl.currentConversationID]"
                                            ng-click="chatWindowModalCtrl.postMessage()"
                                            translate-attr="{ title: 'ui.storefront.common.Send', 'aria-label': 'ui.storefront.common.Send' }"
                                            data-translate="ui.storefront.common.Send"></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!--Product info & contact info tabs-->
            <aside class="popup-aside pt-2">
                <div class="tabset-area">
                    <uib-tabset justified="true">
                        <uib-tab heading="Contact" active="tabStore.active">
                            <p ng-init="tabStore.active = chatWindowModalCtrl.contextProduct ? true : false"
                               ng-bind="ui.storefront.messaging.chat.chatWindow.SellerContactInformation"></p>
                        </uib-tab>
                        <uib-tab heading="Product" ng-show="chatWindowModalCtrl.contextProduct" active="tabProduct.active">
                            <figure class="figure mb-5">
                                <img class="figure-img img-fluid"
                                     alt="{{chatWindowModalCtrl.contextProduct.Name}}"
                                     ng-src="{{chatWindowModalCtrl.contextProduct.PrimaryImageFileName
                                               | corsImageLink : 'products' : { 'maxwidth': 100, 'maxheight': 100, 'mode': 'pad', 'scale': 'both' } }}"
                                     onerror="this.onerror=null;this.src='/DesktopModules/ClarityEcommerce/UI-Storefront/Content/placeholder.jpg?maxwidth=100&amp;maxheight=100&amp;mode=pad&amp;scale=both';" />
                                <figcaption class="figure-caption" ng-bind="chatWindowModalCtrl.contextProduct.Name"></figcaption>
                            </figure>
                            <!--<p class="mb-3">
                                <b>Min. Order:</b>
                                <span class="txt">510 Piece/Pieces gas room heaters vented</span>
                            </p>-->
                            <p class="mb-3" ng-init="tabStore.active = chatWindowModalCtrl.contextProduct ? true : false">
                                <b data-translate="ui.storefront.messaging.chat.chatWindow.FOBPrice"></b>
                                <span class="txt"
                                    ng-bind="(chatWindowModalCtrl.contextProduct.readPrices().isSale
                                              ? chatWindowModalCtrl.contextProduct.readPrices().sale
                                              : chatWindowModalCtrl.contextProduct.readPrices().base) | globalizedCurrency">
                                </span>
                            </p>
                        </uib-tab>
                    </uib-tabset>
                </div>
            </aside>
        </div>
    </div>
</div>
